<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.util.ArrayList" %>
<%@ page import="java.util.List" %>

<%
    List<String> chatList = (List<String>) session.getAttribute("chatList");
    if (chatList == null) {
        chatList = new ArrayList<>();
        session.setAttribute("chatList", chatList);
    }

    String message = request.getParameter("message");
    if (message != null && !message.isEmpty()) {
        chatList.add(message);
    }
%>

<html>
    <head>
        <meta charset="UTF-8">
        <title>Live Chat</title>
        <script>
            function sendMessage() {
                var message = document.getElementById('message').value;
                var xmlhttp = new XMLHttpRequest();

                xmlhttp.onreadystatechange = function() {
                    if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                        document.getElementById('message').value = '';
                    }
                }

                xmlhttp.open('POST', 'userChat.jsp', true);
                xmlhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xmlhttp.send('message=' + message);
            }

            function updateChat() {
                var xmlhttp = new XMLHttpRequest();

                xmlhttp.onreadystatechange = function() {
                    if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                        document.getElementById('chat').innerHTML = xmlhttp.responseText;
                        setTimeout(updateChat, 1000); // Update every second
                    }
                }

                xmlhttp.open('GET', 'userChat.jsp', true);
                xmlhttp.send();
            }
        </script>
    </head>
    <body onload="updateChat()">
        <h1>Live Chat</h1>
        <form onsubmit="sendMessage(); return false;">
            <input type="text" id="message" />
            <input type="submit" value="Send" />
        </form>
        <div id="chat">
            <ul>
                <%
                    for (String msg : chatList) {
                        out.println("<li>" + msg + "</li>");
                    }
                %>
            </ul>
        </div>
    </body>
</html>
